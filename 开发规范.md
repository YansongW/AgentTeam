# 代码开发规范文档

## 1. 开发工作流程

每位开发人员必须严格遵循以下开发流程：

1. **需求分析**
   - 详细阅读需求文档，理解功能要求
   - 与产品经理确认需求细节和边界条件
   - 在需求不明确时及时提出问题

2. **任务分解**
   - 将功能需求分解为小型可实现的任务
   - 在项目管理工具中创建相应的任务卡片
   - 估算每个任务的工作量

3. **分支创建**
   - 从develop分支创建新的功能分支：`feature/功能名`或修复分支：`fix/问题描述`
   - 分支命名应简洁明了，反映功能本质

4. **编码实现**
   - 严格遵循代码风格规范编写代码
   - 实现单元测试，确保测试覆盖率达标
   - 定期提交代码，每次提交应专注于一个小功能点

5. **自测**
   - 在提交PR前，开发人员必须完成功能自测
   - 确保所有单元测试通过
   - 检查代码是否符合规范要求

6. **代码审查**
   - 创建Pull Request请求代码审查
   - 至少需要一位团队成员审查并批准
   - 根据反馈修改代码

7. **集成测试**
   - 合并代码到develop分支后进行集成测试
   - 确保新功能与已有功能无冲突
   - 修复发现的问题

8. **文档更新**
   - 更新相关技术文档和API文档
   - 确保README和使用说明保持最新

9. **部署上线**
   - 按照部署流程将代码部署到测试/生产环境
   - 监控部署过程，确保无异常
   - 进行上线后验证

10. **复盘总结**
    - 记录开发过程中的经验和教训
    - 提出改进建议，持续优化开发流程

## 2. 代码风格

### 命名规范
- **变量和函数**：使用小写字母+下划线（如 `get_user_info`）
- **类名**：使用驼峰式（如 `UserManager`）
- **常量**：全大写+下划线（如 `MAX_RETRY_COUNT`）
- **命名长度**：变量名应清晰表达其用途，避免过于简短的命名（除循环中的迭代变量外）
- **文件名**：使用小写字母+下划线，应反映文件内容（如 `user_manager.py`）

### 代码格式
- **缩进**：统一使用4个空格，不使用Tab
- **行长度**：
  - Python：每行不超过80个字符
  - JavaScript：每行不超过100个字符
- **函数和类的大小**：
  - 单个函数不超过50行
  - 类不超过300行
  - 超过限制时应考虑拆分为更小的单元
- **格式化工具**：
  - Python：使用Black自动格式化
  - JavaScript：使用Prettier自动格式化

### 注释规范
- **文件头注释**：包含文件描述、作者、创建日期
- **函数/方法注释**：说明功能、参数、返回值和异常
- **复杂逻辑处**：添加行内注释解释为什么这样做
- **TODO/FIXME**：标注需要后续改进的地方，但不应大量存在

### 异常处理
- 在关键操作中必须使用try-except处理异常
- 避免捕获过于宽泛的异常（如 `except Exception:`）
- 捕获异常后要么处理，要么记录日志后重新抛出

### 代码检查
- Python：使用PEP 8规范，配合pylint或flake8检查
- JavaScript：使用ESLint检查，配置适当的规则集

## 3. 版本控制

### 工具选择
- 使用Git作为版本控制系统
- 代码托管在GitHub/GitLab上

### 分支管理
- **主分支**：
  - `main`：生产环境代码，受保护不可直接提交
  - `develop`：开发集成分支，也受保护
- **功能分支**：`feature/功能名`（如 `feature/add-agent-api`）
- **修复分支**：`fix/问题描述`（如 `fix/login-timeout`）
- **发布分支**：`release/版本号`（如 `release/v1.2.0`）

### 分支保护
- 主分支（main和develop）启用分支保护规则
- 禁止直接推送代码到主分支，必须通过PR/MR合并
- 合并前需要通过所有自动化测试

### 提交规范
- 提交消息格式：`[类型]: 描述`
- 类型包括：
  - `[feat]`：新功能
  - `[fix]`：修复bug
  - `[docs]`：文档更新
  - `[style]`：代码风格调整（不影响功能）
  - `[refactor]`：代码重构
  - `[test]`：测试相关
  - `[chore]`：构建过程或辅助工具变动
  - `[perf]`：性能优化
- 描述应简明扼要，清晰表达变更内容

### PR/MR流程
- 使用标准化的PR模板，包含：
  - 变更说明
  - 测试情况
  - 文档更新情况
  - 相关依赖变化
- 至少需要一位团队成员的审查和批准
- CI检查必须通过（包括测试和代码规范检查）

### 标签管理
- 为每个正式发布版本打标签：`v主版本.次版本.修订号`
- 遵循语义化版本规范(SemVer)

## 4. 测试要求

### 测试覆盖率
- 总体代码覆盖率不低于80%
- 核心功能和关键业务逻辑覆盖率不低于90%

### 测试分类
- **单元测试**：测试独立功能单元
- **集成测试**：测试模块之间的交互
- **端到端测试**：模拟用户操作测试完整流程
- **性能测试**：验证系统在高负载下的表现

### 测试框架
- Python：使用pytest
- JavaScript：使用Jest
- 可使用Mock框架模拟外部依赖

### 测试数据管理
- 使用工厂模式或固定文件生成测试数据
- 避免测试间数据相互依赖
- 测试完成后清理产生的测试数据

### 测试实践
- 编写边界测试，覆盖边界条件和异常情况
- 明确Mock策略，决定何时使用模拟对象
- 设置专门的自动化测试环境

### 测试报告
- 在CI中自动生成测试覆盖率报告
- 设置覆盖率阈值，低于阈值则构建失败
- 定期检查测试报告，持续改进测试质量

## 5. 文档要求

### 代码内文档
- 使用文档字符串记录代码功能
- 复杂算法需要详细解释实现原理
- 公共API必须有完整文档

### API文档
- 使用Swagger/OpenAPI记录API接口
- 文档需包含：
  - 接口URL和方法
  - 请求参数和格式
  - 返回格式和示例
  - 错误码说明
- 提供在线访问链接

### 项目文档
- **README**：包含项目描述、安装步骤、使用示例
- **架构文档**：使用PlantUML维护系统架构图
- **部署文档**：详细记录部署步骤和环境要求
- **贡献指南**：指导新开发者如何参与项目

### 用户文档
- 如面向最终用户，提供用户手册
- 包含功能说明和常见问题解答
- 配图说明操作流程

### 文档管理
- 文档存储在Git仓库的`docs/`目录下
- 代码变更时同步更新相关文档
- 维护`CHANGELOG.md`记录版本变更

## 6. 部署流程

### 容器化
- 使用Docker容器化应用
- 提供标准化的Dockerfile
- 镜像版本与代码版本保持一致

### CI/CD
- 使用GitHub Actions实现持续集成
- 自动化测试、构建和部署
- 部署前自动运行安全扫描

### 环境管理
- 区分开发、测试、预发布和生产环境
- 使用ConfigMap/Secret管理不同环境配置
- 环境间配置差异最小化

### 数据库迁移
- 使用专业工具（如Alembic）管理数据库变更
- 数据库变更作为部署流程的一部分
- 提供回滚机制

### 发布策略
- 实现蓝绿部署或金丝雀发布
- 新版本先部署到预发布环境验证
- 设置健康检查确保服务正常运行

### 监控与告警
- 集成Prometheus等工具监控系统指标
- 使用ELK/Loki等工具集中管理日志
- 设置关键指标的告警阈值

### 应急流程
- 制定明确的回滚机制和应急预案
- 记录每次部署的详细信息以便追踪
- 定期进行恢复演练

## 7. 安全规范

### 代码安全
- 防止常见安全漏洞（SQL注入、XSS、CSRF等）
- 敏感信息不得硬编码在代码中
- 定期更新依赖包以修复安全漏洞

### 认证与授权
- 实现健壮的认证机制
- 基于角色的访问控制(RBAC)
- 敏感操作需要二次验证

### 数据安全
- 敏感数据必须加密存储
- API通信使用HTTPS
- 实现数据访问审计日志

### 安全检查
- 在CI流程中集成安全扫描工具
- 定期进行渗透测试
- 建立安全问题的响应流程

## 8. 性能与优化

### 性能标准
- 定义关键API的响应时间要求
- 设定系统在特定负载下的表现指标
- 建立性能测试基准

### 代码优化
- 识别和优化性能瓶颈
- 合理使用缓存机制
- 优化数据库查询

### 资源管理
- 合理配置容器资源限制
- 实现自动扩缩容应对流量变化
- 监控资源使用情况，及时优化

## 9. 依赖管理

### 依赖选择
- 优先使用成熟稳定的开源库
- 评估新依赖的必要性和质量
- 避免引入过多重叠功能的依赖

### 版本控制
- 使用依赖锁定文件（如requirements.txt, package-lock.json）
- 明确指定依赖版本，避免使用模糊版本号
- 定期更新依赖以获取安全修复

### 自研组件
- 抽取通用功能形成内部共享库
- 避免代码重复，提高复用率
- 为共享组件提供完善文档和测试

## 10. 技术债务管理

### 识别与记录
- 使用TODO或专门工具记录技术债务
- 评估技术债务的影响范围和紧急程度
- 在迭代计划中安排技术债务处理任务

### 持续改进
- 定期回顾项目代码质量
- 安排20%工时用于代码重构和优化
- 鼓励团队成员提出改进建议

### 指标追踪
- 监控代码复杂度、重复率等指标
- 追踪bug修复时间和频率
- 定期评估技术债务变化趋势

---

本规范由团队共同制定，所有开发人员必须遵守。规范将根据项目需求和团队反馈定期更新。 